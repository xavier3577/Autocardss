<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>AutoCards ‚Äì D√©tection voiture (HF)</title>
<style>
  :root{--bg:#0b0b0b;--panel:#111827;--muted:#9ca3af;--text:#e5e7eb;--ok:#22c55e;--accent:#2563eb;
        --g1:#6b7280;--g2:#9ca3af;--au1:#b8860b;--au2:#ffd700;--iv1:#faf7ef;--iv2:#e9dfc7;--r1:#7f1d1d;--r2:#ef4444;}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:900px;margin:auto;padding:16px}
  h1{margin:0 0 6px 0;font-size:26px;font-weight:900}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:12px}
  label{display:block;color:#93c5fd;font-weight:800;margin-top:10px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #1f2937;background:#0b1320;color:#e5e7eb}
  .row{display:flex;gap:10px} .row > div{flex:1}
  .btn{background:#374151;color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:800;cursor:pointer}
  .btn-ok{background:var(--ok);color:#06251a}
  .muted{color:var(--muted);font-size:12px;margin-top:8px}

  /* Carte */
  .card{border-radius:18px;padding:6px;width:100%;max-width:520px;margin:16px auto 0}
  .card-inner{background:rgba(255,255,255,.85);border:2px solid transparent;border-radius:14px;overflow:hidden;position:relative}
  .card-photo{width:100%;height:240px;object-fit:cover;background:#111}
  .card-header{padding:10px 12px}
  .brand{font-size:18px;font-weight:900;text-transform:uppercase;color:#111827}
  .model{font-size:16px;font-weight:700;opacity:.9;color:#111827}
  .badge{display:inline-block;margin-top:6px;background:rgba(0,0,0,.06);padding:4px 8px;border-radius:6px;font-weight:800;color:#111}
  .specs{background:rgba(255,255,255,.75);padding:12px}
  .spec{display:flex;justify-content:space-between}
  .l{font-weight:800;color:#374151}.v{font-weight:700;color:#111827}

  /* Raret√©s */
  .theme-common{background:linear-gradient(140deg,var(--g1),var(--g2))}.common{border-color:#d1d5db}
  .theme-rare{background:linear-gradient(140deg,var(--au1),var(--au2))}.rare{border-color:#f5deb3}
  .theme-legendary{background:linear-gradient(140deg,var(--iv1),var(--iv2))}.legendary{border-color:#c9b47e}
  .theme-mythic{background:linear-gradient(140deg,var(--r1),var(--r2))}.mythic{border-color:#fecaca}
  .topbar{position:absolute;top:0;left:0;right:0;height:18px;background:rgba(255,255,255,.75)}
  .laurels{position:absolute;top:12px;left:0;right:0;height:30px;display:flex;justify-content:space-between;padding:0 16px}
  .laurels span{width:60px;height:8px;background:#c9b47e;border-radius:8px}
  .laurels .l{transform:rotate(-25deg)} .laurels .r{transform:rotate(25deg)}

  /* Pack opening */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;z-index:50}
  .overlay.show{display:flex}
  .ring{width:min(70vw,320px);height:min(70vw,320px);border:5px solid #c9b47e;border-radius:999px;opacity:.9;animation:spin 1.6s linear infinite}
  .halo{position:absolute;width:min(90vw,420px);height:min(90vw,420px);border:24px solid rgba(255,255,255,.25);border-radius:999px;animation:pulse 1.4s ease-in-out infinite}
  @keyframes spin{to{transform:rotate(360deg)}} @keyframes pulse{0%{opacity:.2}50%{opacity:.6}100%{opacity:.2}}
</style>
</head>
<body>
<div class="wrap">
  <h1>AutoCards</h1>
  <p class="muted">La d√©tection utilise un mod√®le public (Hugging Face). Sans jeton, tu peux remplir √† la main.</p>

  <div class="panel">
    <label>Photo du v√©hicule</label>
    <input id="photo" type="file" accept="image/*" capture="environment">
    <img id="preview" alt="" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px;margin-top:8px;display:none;background:#111">

    <div class="row">
      <div><label>Marque</label><input id="brand" placeholder="Ex: Ferrari"></div>
      <div><label>Mod√®le</label><input id="model" placeholder="Ex: 488 GTB"></div>
    </div>
    <div class="row">
      <div><label>Moteur</label><input id="engine" placeholder="Ex: V8 biturbo"></div>
      <div><label>Ann√©e</label><input id="year" placeholder="2018"></div>
    </div>
    <div class="row">
      <div><label>Puissance (ch)</label><input id="power" placeholder="670"></div>
      <div><label>V. max (km/h)</label><input id="vmax" placeholder="330"></div>
    </div>
    <label>0‚Äì100 km/h (s)</label>
    <input id="zeroTo100" placeholder="3.0">

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button class="btn" id="detectBtn">üîç D√©tecter automatiquement</button>
      <button class="btn btn-ok" id="openPack">üéÅ Ouvrir le pack & cr√©er la carte</button>
    </div>
    <p class="muted">Raret√©: 75% grise, 18% or, 6% l√©gendaire (style FIFA Ic√¥ne), 1% mythique.</p>
  </div>

  <section id="cardView" style="display:none"></section>
</div>

<!-- Pack overlay -->
<div class="overlay" id="overlay">
  <div class="halo"></div>
  <div class="ring"></div>
  <div style="position:relative;z-index:60;text-align:center">
    <div id="overlayTitle" style="font-weight:900;font-size:18px;margin-bottom:6px">Ouverture du pack‚Ä¶</div>
    <div id="overlayRarity" class="reveal" style="color:#c9b47e"></div>
  </div>
</div>

<script>
/* ============= CONFIG ============= */
/* Mets ici ton token Hugging Face (scope read). Laisse vide pour mode manuel. */
const HF_TOKEN = ""; // <-- colle ton token ici (ex: "hf_xxxxxxxxxxxxxxxxx")

/* Mod√®le de classification voiture (Cars196 fine-tun√©) */
const HF_MODEL = "aaraki/vit-base-patch16-224-in21k-finetuned-cars196";

/* ============= UTIL ============= */
const RARITIES = {COMMON:'common',RARE:'rare',LEGENDARY:'legendary',MYTHIC:'mythic'};
const RARITY_WEIGHTS = [
  {k:RARITIES.COMMON,w:0.75},{k:RARITIES.RARE,w:0.18},{k:RARITIES.LEGENDARY,w:0.06},{k:RARITIES.MYTHIC,w:0.01},
];
const RARITY_META = {
  [RARITIES.COMMON]:{name:'Commune',outer:'theme-common',inner:'common'},
  [RARITIES.RARE]:{name:'Rare',outer:'theme-rare',inner:'rare'},
  [RARITIES.LEGENDARY]:{name:'L√©gendaire',outer:'theme-legendary',inner:'legendary'},
  [RARITIES.MYTHIC]:{name:'Mythique',outer:'theme-mythic',inner:'mythic'},
};
function pickRarity(){const r=Math.random();let a=0;for(const x of RARITY_WEIGHTS){a+=x.w;if(r<=a)return x.k}return RARITIES.COMMON}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function spec(l,v){return `<div class="spec"><div class="l">${l}</div><div class="v">${escapeHtml(v)}</div></div>`}

/* Image preview */
const photoInput=document.getElementById('photo');
const preview=document.getElementById('preview');
let imageBlob=null;
photoInput.addEventListener('change', async e=>{
  const file=e.target.files?.[0]; if(!file) return;
  imageBlob=file;
  const url=URL.createObjectURL(file);
  preview.src=url; preview.style.display='block';
});

/* ============= D√âTECTION HF ============= */
async function detectCarWithHF(blob){
  if(!HF_TOKEN){ throw new Error("Aucun token Hugging Face (mode manuel)."); }
  const resp = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`,{
    method:'POST',
    headers:{Authorization:`Bearer ${HF_TOKEN}`},
    body: blob
  });
  if(!resp.ok){
    const t = await resp.text();
    throw new Error(`HF ${resp.status}: ${t.slice(0,200)}`);
  }
  const result = await resp.json();
  // format attendu: [{label:"brand model ...", score:0.xx}, ...]
  if(!Array.isArray(result) || !result.length) throw new Error("Aucun r√©sultat du mod√®le.");
  const best = result[0];
  // essai de split "Brand Model ‚Ä¶"
  const parts = best.label.split(' ');
  const brand = parts.shift() || '';
  const model = parts.join(' ');
  return { brand, model, rawLabel: best.label, score: best.score };
}

/* Bouton D√©tecter */
document.getElementById('detectBtn').addEventListener('click', async ()=>{
  if(!imageBlob){ alert("Ajoute d'abord une photo."); return; }
  try{
    const {brand, model, rawLabel, score} = await detectCarWithHF(imageBlob);
    // Remplit les champs
    document.getElementById('brand').value = brand;
    document.getElementById('model').value = model;
    // Laisse moteur/ann√©e/puissance √† compl√©ter (le mod√®le ne les donne pas)
    alert(`D√©tection: ${rawLabel} (confiance ${(score*100).toFixed(1)}%)`);
  }catch(err){
    alert("D√©tection impossible: " + err.message + "\nTu peux remplir les champs √† la main.");
  }
});

/* ============= PACK + CARTE ============= */
const overlay=document.getElementById('overlay');
document.getElementById('openPack').addEventListener('click', async ()=>{
  if(!imageBlob){ alert("Ajoute d'abord une photo."); return; }

  const rarity = pickRarity();
  document.getElementById('overlayRarity').textContent = RARITY_META[rarity].name;
  overlay.classList.add('show');
  await new Promise(r=>setTimeout(r,2200));
  overlay.classList.remove('show');

  const brand = document.getElementById('brand').value.trim() || '‚Äî';
  const model = document.getElementById('model').value.trim() || '‚Äî';
  const engine = document.getElementById('engine').value.trim() || '‚Äî';
  const year = document.getElementById('year').value.trim() || '‚Äî';
  const power = document.getElementById('power').value.trim() || '‚Äî';
  const vmax = document.getElementById('vmax').value.trim() || '‚Äî';
  const zeroTo100 = document.getElementById('zeroTo100').value.trim() || '‚Äî';

  const imgURL = preview.src;

  const legendaryDecor = rarity==='legendary'
    ? `<div class="topbar"></div><div class="laurels"><span class="l"></span><span class="r"></span></div>` : ``;

  const cardHtml = `
    <div class="card ${RARITY_META[rarity].outer}">
      <div class="card-inner ${RARITY_META[rarity].inner}">
        ${legendaryDecor}
        <img class="card-photo" src="${imgURL}" alt="">
        <div class="card-header">
          <div class="brand">${escapeHtml(brand)}</div>
          <div class="model">${escapeHtml(model)}</div>
          <div class="badge">${RARITY_META[rarity].name}</div>
        </div>
        <div class="specs">
          ${spec('V. max', vmax==='‚Äî'?'‚Äî':vmax+' km/h')}
          ${spec('0‚Äì100', zeroTo100==='‚Äî'?'‚Äî':zeroTo100+' s')}
          ${spec('Puissance', power==='‚Äî'?'‚Äî':power+' ch')}
          ${spec('Moteur', engine)}
          ${spec('Ann√©e', year)}
        </div>
      </div>
    </div>
  `;
  const cv=document.getElementById('cardView'); cv.style.display='block'; cv.innerHTML=cardHtml;
});
</script>
</body>
</html>